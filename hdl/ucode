#   This file is part of JTKCPU.
#   JTKCPU program is free software: you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation, either version 3 of the License, or
#   (at your option) any later version.

#   JTKCPU program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.

#   You should have received a copy of the GNU General Public License
#   along with JTKCPU.  If not, see <http://www.gnu.org/licenses/>.

#   Author: Jose Tejada Gomez. Twitter: @topapate
#   Version: 1.0
#   Date: 3-03-2023

########## INDEX ADDR ##################
PARSE_IDX:          OPD
                    JMP_IDX
                    # IDX_IND either jumps to IDX_IND or
                    # does a IDX_RET depending on the indirect bit

IDX_RINC:           IDX_POST=1, IDX_IND         # 0 - R+
IDX_RINC2:          IDX_POST=1, IDX_IND, IDXW=1 # 1 - R++ / [R++]
IDX_RDEC:           IDX_PRE
                    IDX_IND                     # 2 -  -R
IDX_RDEC2:          IDX_PRE
                    IDX_IND, IDXW=1             # 3 - --R
IDX_OFFSET8:        OPD                         # 4 -  8-bit offset
                    IDX_8, IDX_IND
IDX_OFFSET16:       OPD, MEMHI                  # 5 - 16-bit offset
                    OPD
                    IDX_16, IDX_IND
IDX_IND:            ADDR_IDX, MEMHI              # 6 - ,R
                    ADDR_IDX, ADDR_PLUS1
                    DATA2ADR, IDX_RET
IDX_EXT:            OPD, MEMHI                  # 7 Extended
                    OPD
                    DATA2ADR, IDX_IND
IDX_DP:             OPD                         # 1,4  - DP
                    IDX_DP, IDX_IND
IDX_ACC:            IDX_ACC, IDX_IND            # 1,other  - A, B or D


########## ALU OPERATIONS ##################
SINGLE_ALU:         OPD
                    OPN0=REGS, UP_CC, UP_LD8
                    NI

CMP8:               OPD
                    OPN0=REGS, UP_CC
                    NI

SINGLE_ALU_16:      OPD, MEMHI
                    OPD
                    OPN0=REGS, UP_CC, UP_LD16
                    NI

CMP16:              OPD, MEMHI
                    OPD
                    OPN0=REGS, UP_CC
                    NI

SINGLE_A_INH:       OPN0=REGS, UP_CC, UP_LDA
                    NI

SINGLE_B_INH:       OPN0=REGS, UP_CC, UP_LDB
                    NI

SINGLE_ALU_INH16:   OPN0=REGS, UP_CC, UP_LD16
                    NI

SINGLE_ALU_IDX:     ADDR_IDX
                    OPN0=REGS, UP_CC
                    NI

SINGLE_ALU_IDX16:   ADDR_IDX, MEMHI
                    ADDR_IDX, ADDR_PLUS1
                    OPN0=REGS, UP_CC
                    NI

MULTI_ALU:          OPD
                    OPN0=REGS, WAITALU, UP_CC
                    NI

MEM_ALU_IDX:        OPD, IDX_EN
                    ADDR_IDX
                    OPN0=MEM, WE
                    NI

MULTI_ALU_INH:      OPD
                    OPN0=REGS, UP_CC, WAITALU
                    NI

MULTI_ALU_IDX:      OPD, IDX_EN
                    ADDR_IDX
                    OPN0=REGS, UP_CC, WAITALU
                    NI

WMEM_ALU:           OPD, IDX_EN
                    ADDR_IDX
                    OPN0=MEM, UP_DATA, WAITALU
                    ADDR_IDX, WE
                    NI

MULTIPLY:           NOP     # 11 cycles in 6809 (8 here)
                    NOP
                    NOP
                    NOP
                    NOP
                    NOP     # 6th clock tick
                    UP_CC
                    NI

LMULTIPLY:          NOP     # 20+ cycles in original
                    NOP
                    NOP
                    NOP
                    NOP
                    NOP     # 6th clock tick
                    UP_LMUL # Result goes to {Y,X}
                    NI

######### DECREMENT AND LOOP ##############
LOOPX:              OPD, DECX       # CHECK THAT DECX GOES FIRST
                    PC_XNZ=BRANCH
                    NI

LOOPB:              OPD, DECB
                    PC_BNZ=BRANCH,
                    NI

######### STRING OPERATIONS ##############
MOVE:               OPD, ADRY
                    OPN0=MEM, WE, ADRX, DECU, INCY,
                    INCX, NI

BMOVE:              OPD, ADRY,
                    OPN0=MEM, WE, ADRX, DECU, INCY,
                    INCX, BACK2_UNZ
                    NI

BSETA:              OPN0=A, WE, ADRX, DECU,
                    INCX, BACK1_UNZ
                    NI

BSETD:              OPN0=A, WE, ADRX, INCX,
                    OPN0=B, WE, ADRX, INCX, DECU
                    BACK2_UNZ
                    NI

############### LOAD/STORE OPERATIONS ############
STORE8:             OPD, IDX_EN
                    OPN0=REGS, ADDR_IDX, WE,
                    NI

STORE16:            OPD, IDX_EN
                    OPN0=REGS, ADDR_IDX, WE, MEM16,
                    NI

LD8_IMM:            OPD
                    UP_LD8
                    NI

LD8_IDX:            OPD, IDX_EN
                    ADDR_IDX
                    UP_LD8
                    NI

LD16_IMM:           OPD, MEMHI
                    OPD
                    UP_LD16
                    NI

LD16_IDX:           OPD, IDX_EN
                    ADDR_IDX, MEM16
                    UP_LD16
                    NI

LEA:                UP_LEA
                    NI

############### MISC OPERATIONS ##################
SETLINES:           OPD
                    UP_LINES, NI

NOPE:               NI

############### FLOW CONTROL #####################
SBRANCH:            OPD
                    PC=BRANCH8
                    NI

LBRANCH:            OPD, MEMHI
                    OPD
                    PC=BRANCH16
                    NI

JUMP:               OPD, MEMHI
                    OPD
                    PC=JMP
                    NI

JMSR:               OPD, MEMHI
                    OPD
                    PSH_PC, PSH_GO
                    WE, WAIT_STACK
                    PC=JMP, MEM16
                    NI

RTIT:               RTI_CC, PUL_GO
                    WAIT_STACK
                    RTI_OTHER, PUL_GO
                    WAIT_STACK
                    NI

RTSR:               PUL_PC
                    WAIT_STACK
                    NI

############### STACK ##################
PSH:                OPD
                    PSH_GO
                    WE, WAIT_STACK
                    NI

PUL:                OPD
                    PUL_GO
                    WAIT_STACK
                    NI

########### INTERRUPTS ####################
RESET:              INT_EN
                    NOP
                    NOP
                    NOP
                    NI
                    NOP

FIRQ:               PSH_CC
                    E=0, F=1, I=1, PSH_PC
                    INT_EN
                    NOP
                    NOP
                    NOP
                    NI

IRQ:                PSH_ALL
                    E=1, I=1, INT_EN
                    NOP
                    NOP
                    NOP
                    NI

NMI:                PSH_ALL
                    E=1, I=1, F=1, INT_EN
                    NOP
                    NOP
                    NOP
                    NI

BUSERROR:           BUSERROR